{% extends "reconnaissance/base.html" %}

{% block title %}Settings{% endblock %}

{% block extra_styles %}
    :root { --accent-color: #64748b; }
    
    .settings-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-top: 20px;
    }
    
    .settings-section {
        background: rgba(30, 41, 59, 0.8);
        border-radius: 12px;
        padding: 25px;
        border: 1px solid #334155;
    }
    
    .settings-section h3 {
        color: #64748b;
        margin-bottom: 20px;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .version-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .version-card {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #334155;
    }
    
    .version-card .label {
        color: #94a3b8;
        font-size: 0.85rem;
        margin-bottom: 5px;
    }
    
    .version-card .value {
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        font-family: monospace;
    }
    
    .update-status {
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
    }
    
    .update-status.show {
        display: block;
    }
    
    .update-status.up-to-date {
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid #10b981;
        color: #10b981;
    }
    
    .update-status.update-available {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid #3b82f6;
        color: #3b82f6;
    }
    
    .update-status.error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid #ef4444;
        color: #fca5a5;
    }
    
    .btn-check-updates {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
    }
    
    .btn-check-updates:hover:not(:disabled) {
        background: linear-gradient(135deg, #475569 0%, #334155 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
    }
    
    .btn-check-updates:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .release-info {
        margin-top: 15px;
        padding: 15px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 8px;
        border: 1px solid #334155;
    }
    
    .release-info h4 {
        color: white;
        margin-bottom: 10px;
    }
    
    .release-info .release-body {
        color: #94a3b8;
        font-size: 0.9rem;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .release-info a {
        color: #3b82f6;
        text-decoration: none;
    }
    
    .release-info a:hover {
        text-decoration: underline;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #64748b;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-left: 10px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
{% endblock %}

{% block content %}
<a href="/reconnaissance/" class="back-link">‚Üê Back to Reconnaissance</a>

<div class="page-header">
    <div class="icon">‚öôÔ∏è</div>
    <div>
        <h2>Settings</h2>
        <p class="subtitle">System settings and update management</p>
    </div>
</div>

<div class="settings-container">
    <!-- Version Information Section -->
    <div class="settings-section">
        <h3>üì¶ Version Information</h3>
        
        <div class="version-info">
            <div class="version-card">
                <div class="label">Current Version</div>
                <div class="value" id="current-version">{{ current_version|default:"unknown" }}</div>
                {% if version_source and version_source != "unknown" %}
                <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">Source: {{ version_source }}</div>
                {% endif %}
            </div>
            <div class="version-card">
                <div class="label">Current Commit</div>
                <div class="value" id="current-commit">{{ current_commit|default:"unknown" }}</div>
            </div>
            <div class="version-card">
                <div class="label">Git Branch</div>
                <div class="value" id="git-branch">{{ git_branch|default:"unknown" }}</div>
            </div>
            <div class="version-card">
                <div class="label">Repository</div>
                <div class="value" style="font-size: 0.9rem; word-break: break-all;">
                    <a href="{{ repository_url }}" target="_blank" style="color: #3b82f6; text-decoration: none;">
                        {{ repository_owner }}/{{ repository_name }}
                    </a>
                </div>
                {% if git_remote_url %}
                <div style="font-size: 0.7rem; color: #64748b; margin-top: 5px; font-family: monospace;">
                    {{ git_remote_url }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <button class="btn-check-updates" id="check-updates-btn" onclick="checkForUpdates()">
            üîÑ Check for Updates
        </button>
        
        <div class="update-status" id="update-status"></div>
    </div>
    
    <!-- System Information Section -->
    <div class="settings-section">
        <h3>‚ÑπÔ∏è System Information</h3>
        <p style="color: #94a3b8; line-height: 1.6;">
            This system provides autonomous reconnaissance capabilities through multiple specialized agents.
            Check for updates regularly to ensure you have the latest features and security improvements.
        </p>
    </div>
</div>

<script>
async function checkForUpdates() {
    const btn = document.getElementById('check-updates-btn');
    const statusDiv = document.getElementById('update-status');
    
    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = 'Checking... <span class="loading-spinner"></span>';
    statusDiv.className = 'update-status';
    statusDiv.style.display = 'none';
    
    try {
        const response = await fetch('/reconnaissance/api/github/check-updates/');
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'update-status show';
            
            if (data.update_available) {
                statusDiv.classList.add('update-available');
                let html = `<h4 style="margin-top: 0; color: #3b82f6;">‚ú® Update Available!</h4>`;
                html += `<p><strong>Latest Version:</strong> ${data.latest_tag || data.latest_tag || 'Unknown'}</p>`;
                html += `<p><strong>Current Version:</strong> ${data.current_version}</p>`;
                
                if (data.latest_release) {
                    html += `<div class="release-info">`;
                    html += `<h4>${data.latest_release.name || data.latest_release.tag_name}</h4>`;
                    html += `<p><strong>Published:</strong> ${new Date(data.latest_release.published_at).toLocaleString()}</p>`;
                    if (data.latest_release.html_url) {
                        html += `<p><a href="${data.latest_release.html_url}" target="_blank">View Release on GitHub ‚Üí</a></p>`;
                    }
                    if (data.latest_release.body) {
                        html += `<div class="release-body">${escapeHtml(data.latest_release.body)}</div>`;
                    }
                    html += `</div>`;
                }
                
                statusDiv.innerHTML = html;
            } else {
                statusDiv.classList.add('up-to-date');
                statusDiv.innerHTML = `
                    <h4 style="margin-top: 0; color: #10b981;">‚úÖ You're up to date!</h4>
                    <p>Current version: <strong>${data.current_version}</strong></p>
                    <p>You have the latest version of the software.</p>
                `;
            }
        } else {
            statusDiv.className = 'update-status show error';
            statusDiv.innerHTML = `
                <h4 style="margin-top: 0; color: #fca5a5;">‚ùå Error Checking for Updates</h4>
                <p>${data.error || 'Failed to check for updates. Please try again later.'}</p>
            `;
        }
    } catch (error) {
        statusDiv.className = 'update-status show error';
        statusDiv.innerHTML = `
            <h4 style="margin-top: 0; color: #fca5a5;">‚ùå Connection Error</h4>
            <p>Failed to connect to GitHub API: ${error.message}</p>
            <p>Please check your internet connection and try again.</p>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Check for Updates';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}
