{% extends "reconnaissance/base.html" %}

{% block title %}Oak Coordinator Dashboard{% endblock %}

{% block extra_styles %}
    :root { --accent-color: #10b981; }
{% endblock %}

{% block content %}
<a href="/reconnaissance/" class="back-link">â† Back to Reconnaissance</a>

<div class="page-header">
    <div class="icon">ğŸŒ³</div>
    <div>
        <h2>Oak Coordinator Dashboard</h2>
        <p class="subtitle">Task coordination and curation overview</p>
    </div>
</div>

{% if error %}
<div class="error-message">
    <strong>Database Error:</strong> {{ error }}
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="label">Total Fingerprints</div>
        <div class="value">{{ stats.total_fingerprints|default:0 }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">Technology fingerprints</div>
    </div>
    <div class="stat-card">
        <div class="label">CVE Matches</div>
        <div class="value">{{ stats.total_cve_matches|default:0 }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">CVE fingerprint matches</div>
    </div>
    <div class="stat-card">
        <div class="label">Total Curated</div>
        <div class="value">{{ stats.total_curated|default:0 }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">Targets curated</div>
    </div>
    <div class="stat-card">
        <div class="label">Pending Curation</div>
        <div class="value">{{ stats.pending_curation|default:0 }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">Awaiting curation</div>
    </div>
    <div class="stat-card">
        <div class="label">Recent Curations</div>
        <div class="value">{{ stats.recent_curations|default:0 }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">Last 24 hours</div>
    </div>
    <div class="stat-card">
        <div class="label">Autonomous Service</div>
        <div class="value">
            {% if stats.autonomous_service_running %}
                <span style="color: #10b981;">âœ… Running</span>
            {% else %}
                <span style="color: #ef4444;">âŒ Stopped</span>
            {% endif %}
        </div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">
            Batches: {{ stats.curation_batches|default:0 }}, Processed: {{ stats.targets_processed|default:0 }}
        </div>
    </div>
</div>

<h3 style="margin-bottom: 15px; color: #10b981;">ğŸ“‹ Recent Curations</h3>

<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>Target</th>
                <th>Curated At</th>
            </tr>
        </thead>
        <tbody>
            {% for curation in recent_curations %}
            <tr>
                <td>{{ curation.subdomain|truncatechars:60 }}</td>
                <td>
                    {% if curation.curated_at %}
                        {{ curation.curated_at|date:"Y-m-d H:i:s" }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2" style="text-align: center; color: #94a3b8;">No recent curations found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h3 style="margin-bottom: 15px; margin-top: 30px; color: #10b981;">ğŸ› ï¸ Oak Coordinator Functions</h3>

<div style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div>
            <h4 style="color: #10b981; margin-bottom: 10px;">Nuclei Template Curation</h4>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                Oak coordinates Nuclei template recommendations for Surge based on technology fingerprints and CVE matches.
            </p>
            <button onclick="refreshTemplates()" 
                    style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;"
                    id="refresh-templates-btn">
                ğŸ”„ Refresh Templates
            </button>
            <div id="refresh-status" style="margin-top: 8px; font-size: 0.85rem; color: #94a3b8;"></div>
        </div>
        
        <div>
            <h4 style="color: #10b981; margin-bottom: 10px;">Target Curation</h4>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">
                Autonomous curation service processes targets and updates curation status automatically.
            </p>
            <div style="font-size: 0.85rem; color: #64748b;">
                Status: 
                {% if stats.autonomous_service_running %}
                    <span style="color: #10b981;">Active</span>
                {% else %}
                    <span style="color: #ef4444;">Inactive</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<h3 style="margin-bottom: 15px; margin-top: 30px; color: #10b981;">ğŸ“¤ Upload Curation Data</h3>

<div style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Nuclei Templates Upload -->
        <div style="border: 1px solid #334155; border-radius: 6px; padding: 15px;">
            <h4 style="color: #10b981; margin-bottom: 10px; font-size: 1rem;">ğŸ“„ Nuclei Templates</h4>
            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">
                Upload YAML template files, directories, or ZIP archives for Oak to index and correlate.
            </p>
            <form id="upload-templates-form" enctype="multipart/form-data" style="margin-bottom: 10px;">
                <input type="file" id="templates-file" name="template" accept=".yaml,.yml,.zip" 
                       style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; margin-bottom: 8px;"
                       multiple>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.85rem; color: #94a3b8;">
                    <input type="checkbox" id="auto-index-templates" checked>
                    Auto-index after upload
                </label>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.85rem; color: #94a3b8;">
                    <input type="checkbox" id="force-rescan-templates">
                    Force rescan existing templates
                </label>
                <button type="submit" 
                        style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                    ğŸ“¤ Upload Templates
                </button>
            </form>
            <div id="templates-upload-status" style="font-size: 0.85rem; color: #94a3b8; margin-top: 8px;"></div>
        </div>
        
        <!-- CVE Data Upload -->
        <div style="border: 1px solid #334155; border-radius: 6px; padding: 15px;">
            <h4 style="color: #10b981; margin-bottom: 10px; font-size: 1rem;">ğŸ”’ CVE Data</h4>
            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">
                Upload CVE information in JSON or CSV format. Requires egg_record_id in data or form.
            </p>
            <form id="upload-cves-form" enctype="multipart/form-data" style="margin-bottom: 10px;">
                <input type="file" id="cves-file" name="cves" accept=".json,.csv" 
                       style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; margin-bottom: 8px;">
                <input type="text" id="cve-egg-record-id" name="egg_record_id" placeholder="EggRecord ID (if not in file)" 
                       style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; margin-bottom: 8px; font-size: 0.85rem;">
                <button type="submit" 
                        style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                    ğŸ“¤ Upload CVEs
                </button>
            </form>
            <div id="cves-upload-status" style="font-size: 0.85rem; color: #94a3b8; margin-top: 8px;"></div>
        </div>
        
        <!-- Technology Fingerprints Upload -->
        <div style="border: 1px solid #334155; border-radius: 6px; padding: 15px;">
            <h4 style="color: #10b981; margin-bottom: 10px; font-size: 1rem;">ğŸ” Technology Fingerprints</h4>
            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">
                Upload technology fingerprint data in JSON format to enrich target intelligence.
            </p>
            <form id="upload-fingerprints-form" enctype="multipart/form-data" style="margin-bottom: 10px;">
                <input type="file" id="fingerprints-file" name="fingerprints" accept=".json" 
                       style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; margin-bottom: 8px;">
                <input type="text" id="egg-record-id" name="egg_record_id" placeholder="EggRecord ID (optional)" 
                       style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; margin-bottom: 8px; font-size: 0.85rem;">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.85rem; color: #94a3b8;">
                    <input type="checkbox" id="auto-curate-fingerprints">
                    Auto-trigger curation after upload
                </label>
                <button type="submit" 
                        style="width: 100%; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                    ğŸ“¤ Upload Fingerprints
                </button>
            </form>
            <div id="fingerprints-upload-status" style="font-size: 0.85rem; color: #94a3b8; margin-top: 8px;"></div>
        </div>
    </div>
</div>

<h3 style="margin-bottom: 15px; margin-top: 30px; color: #10b981;">ğŸ“Š API Endpoints</h3>

<div style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 20px;">
    <ul style="list-style: none; padding: 0; margin: 0;">
        <li style="padding: 8px 0; border-bottom: 1px solid #334155;">
            <span style="color: #10b981;">ğŸ“¡</span>
            <a href="/reconnaissance/api/oak/nuclei-templates/" style="color: #60a5fa; text-decoration: none; margin-left: 10px;">
                /api/oak/nuclei-templates/&lt;egg_record_id&gt;/</a>
            <span style="color: #94a3b8; margin-left: 10px;">- Get recommended Nuclei templates</span>
        </li>
        <li style="padding: 8px 0; border-bottom: 1px solid #334155;">
            <span style="color: #10b981;">ğŸ”„</span>
            <span style="color: #60a5fa; margin-left: 10px;">POST /api/oak/refresh-templates/</span>
            <span style="color: #94a3b8; margin-left: 10px;">- Refresh template registry</span>
        </li>
        <li style="padding: 8px 0; border-bottom: 1px solid #334155;">
            <span style="color: #10b981;">ğŸ¯</span>
            <span style="color: #60a5fa; margin-left: 10px;">POST /api/oak/curate-sample/</span>
            <span style="color: #94a3b8; margin-left: 10px;">- Curate sample target</span>
        </li>
        <li style="padding: 8px 0; border-bottom: 1px solid #334155;">
            <span style="color: #10b981;">ğŸ“¤</span>
            <span style="color: #60a5fa; margin-left: 10px;">POST /api/oak/upload-templates/</span>
            <span style="color: #94a3b8; margin-left: 10px;">- Upload Nuclei templates</span>
        </li>
        <li style="padding: 8px 0; border-bottom: 1px solid #334155;">
            <span style="color: #10b981;">ğŸ“¤</span>
            <span style="color: #60a5fa; margin-left: 10px;">POST /api/oak/upload-cves/</span>
            <span style="color: #94a3b8; margin-left: 10px;">- Upload CVE data</span>
        </li>
        <li style="padding: 8px 0;">
            <span style="color: #10b981;">ğŸ“¤</span>
            <span style="color: #60a5fa; margin-left: 10px;">POST /api/oak/upload-fingerprints/</span>
            <span style="color: #94a3b8; margin-left: 10px;">- Upload technology fingerprints</span>
        </li>
    </ul>
</div>

<script>
function refreshTemplates() {
    const btn = document.getElementById('refresh-templates-btn');
    const status = document.getElementById('refresh-status');
    
    btn.disabled = true;
    btn.style.opacity = '0.6';
    status.textContent = 'Refreshing templates...';
    status.style.color = '#3b82f6';
    
    fetch('/reconnaissance/api/oak/refresh-templates/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            status.textContent = `âœ… ${data.message || 'Templates refreshed successfully'}`;
            status.style.color = '#10b981';
        } else {
            status.textContent = `âŒ Error: ${data.error || 'Failed to refresh templates'}`;
            status.style.color = '#ef4444';
        }
    })
    .catch(error => {
        status.textContent = `âŒ Error: ${error.message}`;
        status.style.color = '#ef4444';
        console.error('Refresh templates error:', error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}

// Upload Templates Handler
document.getElementById('upload-templates-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const status = document.getElementById('templates-upload-status');
    const formData = new FormData();
    const fileInput = document.getElementById('templates-file');
    const autoIndex = document.getElementById('auto-index-templates').checked;
    const forceRescan = document.getElementById('force-rescan-templates').checked;
    
    if (!fileInput.files || fileInput.files.length === 0) {
        status.textContent = 'âŒ Please select a file to upload';
        status.style.color = '#ef4444';
        return;
    }
    
    // Add all selected files
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('templates[]', fileInput.files[i]);
    }
    
    status.textContent = 'â³ Uploading templates...';
    status.style.color = '#3b82f6';
    
    try {
        const url = `/reconnaissance/api/oak/upload-templates/?auto_index=${autoIndex}&force_rescan=${forceRescan}`;
        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            status.textContent = `âœ… Uploaded ${data.uploaded} template(s). Indexed: ${data.indexed}, Updated: ${data.updated}, Skipped: ${data.skipped}${data.error_count > 0 ? `, Errors: ${data.error_count}` : ''}`;
            status.style.color = '#10b981';
            fileInput.value = ''; // Clear file input
        } else {
            status.textContent = `âŒ Error: ${data.error || 'Upload failed'}`;
            status.style.color = '#ef4444';
        }
    } catch (error) {
        status.textContent = `âŒ Error: ${error.message}`;
        status.style.color = '#ef4444';
        console.error('Upload templates error:', error);
    }
});

// Upload CVEs Handler
document.getElementById('upload-cves-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const status = document.getElementById('cves-upload-status');
    const formData = new FormData();
    const fileInput = document.getElementById('cves-file');
    const eggRecordId = document.getElementById('cve-egg-record-id').value;
    
    if (!fileInput.files || fileInput.files.length === 0) {
        status.textContent = 'âŒ Please select a file to upload';
        status.style.color = '#ef4444';
        return;
    }
    
    formData.append('cves', fileInput.files[0]);
    if (eggRecordId) {
        formData.append('egg_record_id', eggRecordId);
    }
    
    status.textContent = 'â³ Uploading CVE data...';
    status.style.color = '#3b82f6';
    
    try {
        const response = await fetch('/reconnaissance/api/oak/upload-cves/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            status.textContent = `âœ… Processed ${data.processed} CVE(s)${data.error_count > 0 ? `, Errors: ${data.error_count}` : ''}`;
            status.style.color = '#10b981';
            fileInput.value = ''; // Clear file input
            document.getElementById('cve-egg-record-id').value = ''; // Clear egg record ID
        } else {
            status.textContent = `âŒ Error: ${data.error || 'Upload failed'}`;
            status.style.color = '#ef4444';
        }
    } catch (error) {
        status.textContent = `âŒ Error: ${error.message}`;
        status.style.color = '#ef4444';
        console.error('Upload CVEs error:', error);
    }
});

// Upload Fingerprints Handler
document.getElementById('upload-fingerprints-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const status = document.getElementById('fingerprints-upload-status');
    const formData = new FormData();
    const fileInput = document.getElementById('fingerprints-file');
    const eggRecordId = document.getElementById('egg-record-id').value;
    const autoCurate = document.getElementById('auto-curate-fingerprints').checked;
    
    if (!fileInput.files || fileInput.files.length === 0) {
        status.textContent = 'âŒ Please select a file to upload';
        status.style.color = '#ef4444';
        return;
    }
    
    formData.append('fingerprints', fileInput.files[0]);
    if (eggRecordId) {
        formData.append('egg_record_id', eggRecordId);
    }
    if (autoCurate) {
        formData.append('auto_curate', 'true');
    }
    
    status.textContent = 'â³ Uploading fingerprints...';
    status.style.color = '#3b82f6';
    
    try {
        const response = await fetch('/reconnaissance/api/oak/upload-fingerprints/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            let message = `âœ… Processed ${data.processed} fingerprint(s)`;
            if (data.curation && data.curation.queued) {
                message += ', Curation queued';
            }
            if (data.error_count > 0) {
                message += `, Errors: ${data.error_count}`;
            }
            status.textContent = message;
            status.style.color = '#10b981';
            fileInput.value = ''; // Clear file input
            document.getElementById('egg-record-id').value = ''; // Clear egg record ID
        } else {
            status.textContent = `âŒ Error: ${data.error || 'Upload failed'}`;
            status.style.color = '#ef4444';
        }
    } catch (error) {
        status.textContent = `âŒ Error: ${error.message}`;
        status.style.color = '#ef4444';
        console.error('Upload fingerprints error:', error);
    }
});
</script>

{% endblock %}
